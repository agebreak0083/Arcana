<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>아르카나 코드: 작전 코딩 시뮬레이션</title>
    <!-- Tailwind CSS 로드 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');

        /* 기본 스타일: 다크 테마 및 폰트 설정 */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827;
            /* gray-900 */
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 1rem;
            /* p-4 */
        }

        /* 스크롤바 디자인 */
        .custom-scroll::-webkit-scrollbar {
            width: 8px;
        }

        .custom-scroll::-webkit-scrollbar-thumb {
            background-color: #4a5568;
            /* gray-600 */
            border-radius: 4px;
        }

        .custom-scroll::-webkit-scrollbar-track {
            background-color: #1f2937;
            /* gray-800 */
        }

        /* 공통 캐릭터 카드 스타일 */
        .character-card,
        .slot-card {
            aspect-ratio: 1 / 1;
            /* 정사각형 카드 */
            border-radius: 0.75rem;
            /* rounded-xl */
            overflow: hidden;
            position: relative;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5), 0 2px 4px -2px rgba(0, 0, 0, 0.5);
            transition: all 0.2s;
            cursor: pointer;
        }

        .character-card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .character-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: rgba(0, 0, 0, 0.85);
            padding: 0.25rem 0.5rem;
            text-align: center;
            font-size: 0.65rem;
            /* text-[10px] */
            font-weight: 700;
        }

        .selected-pool-card {
            border: 4px solid #fcd34d;
            /* yellow-300 */
            box-shadow: 0 0 15px rgba(252, 211, 77, 0.7);
        }

        .deployed-card-slot {
            /* 배치된 슬롯의 카드 보더 */
            border: 3px solid #38bdf8;
            /* sky-400 */
        }

        /* 빈 슬롯 스타일 */
        .empty-slot {
            background-color: #374151;
            /* gray-700 */
            border: 2px dashed #4b5563;
            /* gray-600 */
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            color: #9ca3af;
            /* gray-400 */
            font-size: 0.875rem;
            font-weight: 600;
            user-select: none;
        }

        /* 활성 슬롯 (배치 준비, 또는 현재 코딩 편집 중) */
        .active-slot {
            border: 2px dashed #a7f3d0 !important;
            /* teal-200 */
            background-color: #134e4a !important;
            /* Dark teal for active */
            color: #a7f3d0 !important;
            box-shadow: 0 0 10px rgba(167, 243, 208, 0.5);
        }

        /* 코스트 색상 */
        .cost-1 {
            background-color: #10b981;
        }

        /* emerald-500 (Green) */
        .cost-2 {
            background-color: #3b82f6;
        }

        /* blue-500 (Blue) */
        .cost-3 {
            background-color: #ef4444;
        }

        /* red-500 (Red) */

        /* 코딩 패널 내부 스타일 */
        .coding-entry {
            transition: background-color 0.15s;
        }

        .coding-entry:hover {
            background-color: #374151;
            /* gray-700 */
        }

        /* 조건 선택 필드 스타일 */
        .condition-field {
            @apply bg-gray-900 border border-gray-600 rounded p-1 text-white text-xs cursor-pointer truncate h-8 flex items-center justify-between;
            transition: all 0.15s;
        }

        .condition-field:hover {
            @apply border-teal-400 bg-gray-700;
        }

        /* 모달 리스트 아이템 */
        .modal-list-item {
            @apply p-3 rounded-lg text-sm cursor-pointer transition duration-100;
        }

        .modal-list-item-category {
            @apply bg-gray-600 hover:bg-yellow-700/50 text-white font-semibold;
        }

        .modal-list-item-category.selected {
            @apply bg-yellow-600 text-gray-900 shadow-lg ring-2 ring-yellow-400;
        }

        .modal-list-item-detail {
            @apply bg-gray-700 hover:bg-teal-700/50 text-gray-200 font-medium border border-gray-700;
        }

        .modal-list-item-detail:hover {
            @apply border-teal-500;
        }

        /* Mobile Optimization: Adjust main content margin on smaller screens */
        @media (max-width: 1023px) {
            main {
                flex-direction: column;
                gap: 1.5rem;
                /* gap-6 */
            }
        }
    </style>
</head>

<body class="bg-gray-900 text-white">

    <div class="max-w-7xl mx-auto w-full">
        <header class="mb-6 py-2 border-b border-teal-800">
            <h1 class="text-3xl font-extrabold text-teal-400 tracking-wider">ARCANA CODE: 작전 코딩 설정</h1>
            <p class="text-gray-400 mt-1 text-sm">유니콘 오버로드 스타일 작전 시스템: <span class="text-yellow-400 font-bold">[조건 1]
                    AND [조건 2]</span> 충족 시 스킬 발동</p>
        </header>
    </div>

    <!-- Main Content Area -->
    <main class="flex flex-col lg:flex-row gap-6 max-w-7xl mx-auto w-full flex-grow">

        <!-- 1. 좌측: 부대 편성 및 캐릭터 정보 패널 (1/3 너비) -->
        <div class="lg:w-1/3 space-y-4 flex flex-col">
            <!-- 부대 정보 카드 -->
            <div id="unit-info" class="bg-gray-800 p-5 rounded-xl shadow-2xl border border-teal-700/50">
                <h2 class="text-xl font-semibold mb-3 text-yellow-300">부대 정보</h2>
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">부대명:</span>
                        <span class="font-bold text-white">코드 브레이커 A</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">부대 코스트 (현재/최대):</span>
                        <span class="font-extrabold text-lg text-teal-400" id="current-cost">0 / 15</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">랭킹 모드:</span>
                        <span class="font-medium text-red-400">코스트 제한 (Lv.10)</span>
                    </div>
                </div>
            </div>

            <!-- 부대 편성 그리드 -->
            <div class="bg-gray-800 p-5 rounded-xl shadow-2xl border border-teal-700/50">
                <h2 class="text-xl font-semibold mb-4 text-yellow-300">부대 편성 (Front 3 / Back 3)</h2>
                <div class="grid grid-cols-3 gap-3">
                    <div class="col-span-3 text-sm font-semibold text-gray-400 mb-1">전열 (Front)</div>
                    <div id="slot-0" class="slot-card empty-slot cursor-pointer hover:bg-gray-600 transition">Front 1
                    </div>
                    <div id="slot-1" class="slot-card empty-slot cursor-pointer hover:bg-gray-600 transition">Front 2
                    </div>
                    <div id="slot-2" class="slot-card empty-slot cursor-pointer hover:bg-gray-600 transition">Front 3
                    </div>
                    <div class="col-span-3 text-sm font-semibold text-gray-400 mt-3 mb-1">후열 (Back)</div>
                    <div id="slot-3" class="slot-card empty-slot cursor-pointer hover:bg-gray-600 transition">Back 1
                    </div>
                    <div id="slot-4" class="slot-card empty-slot cursor-pointer hover:bg-gray-600 transition">Back 2
                    </div>
                    <div id="slot-5" class="slot-card empty-slot cursor-pointer hover:bg-gray-600 transition">Back 3
                    </div>
                </div>
                <button id="clear-unit-btn"
                    class="mt-4 w-full text-xs py-2 bg-red-800/50 text-red-300 rounded-lg hover:bg-red-700/50 transition duration-150">부대
                    초기화</button>
            </div>

            <!-- 나의 캐릭터 풀 -->
            <div class="bg-gray-800 p-5 rounded-xl shadow-2xl border border-teal-700/50">
                <h2 class="text-xl font-semibold mb-4 text-yellow-300">나의 캐릭터 풀</h2>
                <div id="character-pool-container"
                    class="grid grid-cols-4 gap-3 custom-scroll max-h-[22rem] overflow-y-auto pr-2">
                    <!-- JS 생성 -->
                </div>
                <p class="text-xs text-gray-500 mt-3">캐릭터를 클릭 후, 위의 빈 슬롯을 클릭하여 배치하세요.</p>
            </div>

        </div>

        <!-- 2. 우측: 작전 코딩 목록 패널 (2/3 너비) -->
        <div class="lg:w-2/3 space-y-4 flex flex-col">

            <!-- 선택된 캐릭터 상세 -->
            <div id="detail-panel"
                class="bg-gray-800 p-5 rounded-xl shadow-2xl border border-yellow-700/50 flex gap-4 hidden">
                <!-- JS 생성 -->
            </div>

            <!-- 작전 코딩 패널 -->
            <div
                class="bg-gray-800 p-5 rounded-xl shadow-2xl border border-teal-700/50 flex flex-col flex-grow min-h-0">
                <div class="flex justify-between items-center border-b border-gray-700 pb-2 mb-2">
                    <h2 class="text-2xl font-bold text-teal-400" id="coding-panel-title">캐릭터 선택 대기</h2>
                    <div class="text-xs text-gray-400 bg-gray-900 px-2 py-1 rounded border border-gray-700">
                        <span class="text-yellow-400 font-bold">AND(&&) 관계:</span> 조건 1과 조건 2를 모두 만족할 때 실행
                    </div>
                </div>

                <!-- 코딩 내용 영역 -->
                <div id="coding-area-content" class="flex-grow overflow-y-auto custom-scroll">
                    <p class="text-gray-400 text-center py-12">캐릭터를 선택하거나 배치된 캐릭터의 슬롯을 클릭하면, 해당 캐릭터의 작전 코딩 목록이 표시됩니다.
                    </p>
                </div>
            </div>

        </div>

    </main>

    <!-- 3. 조건 선택 모달 패널 (Hidden by default) -->
    <div id="condition-modal" class="hidden fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4">
        <div
            class="bg-gray-900 rounded-xl shadow-2xl w-full max-w-4xl max-h-[80vh] overflow-hidden flex flex-col border-4 border-teal-600">
            <div class="p-4 bg-gray-900 border-b border-teal-600 flex justify-between items-center">
                <h3 class="text-2xl font-bold text-yellow-300">작전 조건 선택</h3>
                <button onclick="closeModal()"
                    class="text-gray-400 hover:text-white transition text-3xl leading-none">&times;</button>
            </div>
            <div class="flex flex-grow overflow-hidden">
                <!-- Layer 1: Category -->
                <div class="w-1/3 flex flex-col">
                    <div class="p-3 text-sm font-extrabold text-teal-300 bg-gray-800 border-b border-gray-700">카테고리
                    </div>
                    <div id="category-list" class="bg-gray-800 custom-scroll overflow-y-auto p-2 space-y-1">
                        <!-- Categories will be rendered here -->
                    </div>
                </div>
                <!-- Layer 2: Detail Conditions -->
                <div class="w-2/3 flex flex-col">
                    <div class="p-3 text-sm font-extrabold text-teal-300 bg-gray-800 border-b border-l border-gray-700">
                        세부 조건</div>
                    <div id="condition-list"
                        class="bg-gray-900 custom-scroll overflow-y-auto p-4 space-y-2 border-l border-gray-700">
                        <p class="text-center text-gray-400 mt-12">좌측에서 카테고리를 선택해 주세요.</p>
                        <!-- Details will be rendered here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto w-full">
        <footer class="mt-8 text-center text-gray-500 text-xs">
            <p>저장 시 파일명 규정: [ID]_[날짜][시간].html (예: agebreak_2511201504.html)</p>
            <p class="mt-1">© 2024 Arcana Code Tactics. Unicorn Overlord Inspired System.</p>
        </footer>
    </div>

    <script>
        // ==========================================
        // 0. 유니콘 오버로드 스타일 작전 조건 데이터 (JSON 반영)
        // ==========================================

        // 첨부된 JSON 파일을 직접 JavaScript 객체로 정의합니다.
        const TACTICS_DB = {
            "대열_상황": [
                "전열의 적/아군 우선", "후열의 적/아군 우선", "전열의 적/아군 한정",
                "후열의 적/아군 한정", "전후열 나란히 배치된 적/아군 한정",
                "인원이 가장 많은 열의 적/아군 우선", "인원이 가장 적은 열의 적/아군 우선",
                "2체 이상 있는 열의 적/아군 한정", "3체 이상 있는 열의 적/아군 한정",
                "낮 시간 한정", "밤 시간 한정"
            ],
            "병종": [
                "보병계 적/아군 우선", "기마계 적/아군 우선", "비행계 적/아군 우선",
                "중장계 적/아군 우선", "정찰계 적/아군 우선", "궁병계 적/아군 우선",
                "술사계 적/아군 우선", "엘프 적/아군 우선", "수인 적/아군 우선",
                "유익인 적/아군 우선", "보병계 적/아군 한정", "기마계 적/아군 한정",
                "비행계 적/아군 한정", "중장계 적/아군 한정", "정찰계 적/아군 한정",
                "궁병계 적/아군 한정", "술사계 적/아군 한정", "엘프 적/아군 한정",
                "수인 적/아군 한정", "유익인 적/아군 한정"
            ],
            "HP_관련": [
                "HP가 가장 높은 적/아군 우선", "HP가 가장 낮은 적/아군 우선",
                "HP 비율이 가장 높은 적/아군 우선", "HP 비율이 가장 낮은 적/아군 우선",
                "HP 25% 이하 한정", "HP 50% 이하 한정", "HP 75% 이하 한정",
                "HP 25% 이상 한정", "HP 50% 이상 한정", "HP 75% 이상 한정",
                "HP 100% 이상 한정", "HP 100% 미만 한정",
                "평균 HP 25% 이하 한정", "평균 HP 50% 이하 한정", "평균 HP 75% 이하 한정",
                "평균 HP 25% 이상 한정", "평균 HP 50% 이상 한정", "평균 HP 75% 이상 한정",
                "평균 HP 100% 이상 한정", "평균 HP 100% 미만 한정"
            ],
            "AP_PP_관련": [
                "AP가 가장 높은 적/아군 우선", "AP가 가장 낮은 적/아군 우선",
                "AP가 0 한정", "AP 1 이하 한정", "AP 2 이하 한정", "AP 3 이하 한정",
                "AP 1 이상 한정", "AP 2 이상 한정", "AP 3 이상 한정", "AP 4 이상 한정",
                "PP가 가장 높은 적/아군 우선", "PP가 가장 낮은 적/아군 우선",
                "PP가 0 한정", "PP 1 이하 한정", "PP 2 이하 한정", "PP 3 이하 한정",
                "PP 1 이상 한정", "PP 2 이상 한정", "PP 3 이상 한정", "PP 4 이상 한정"
            ],
            "기타_상태": [
                "조건 없음", // 기본 조건
                "적: 버프 상태", "적: 디버프 상태", "자신: 버프 상태", "자신: 디버프 상태",
                "적: 상태 이상", "첫 번째 행동 한정", "마지막 행동 한정",
                "공격 가능한 적이 없음", "스킬 사용 불가", "PP 보유"
            ]
        };

        // 조건이 없는 경우 기본값
        const DEFAULT_CONDITION = "조건 없음";


        // 1. 캐릭터 데이터 정의
        const MAX_COST = 15;
        const characters = [
            { id: 'raina', name: 'Raina (레이나)', class: 'Knight (기사)', cost: 3, arcana: '돌격 전술', speed: 65, desc: '기마병 타입. 보병에게 강력하며, 기동성이 뛰어남.', imgSeed: 10, skills: [{ name: '어썰트 랜스', type: 'AP' }, { name: '롱 스러스트', type: 'AP' }, { name: '가드', type: 'PP' }, { name: '와일드 러시', type: 'AP' }] },
            { id: 'elara', name: 'Elara (엘라라)', class: 'Lord (군주)', cost: 3, arcana: '지휘 계통', speed: 70, desc: '부대의 리더. 능력치가 균형 잡혀 있으며, 광범위한 버프 및 디버프 스킬을 보유합니다.', imgSeed: 11, skills: [{ name: '로얄 오더', type: 'AP' }, { name: '리더스 오라', type: 'PP' }, { name: '파이어 볼', type: 'AP' }, { name: '힐', type: 'AP' }] },
            { id: 'sera', name: 'Sera (세라)', class: 'Witch (마녀)', cost: 3, arcana: '광역 마법', speed: 50, desc: '후열 마법 딜러. 적의 방어력을 무시하는 광역 마법 공격이 특기입니다.', imgSeed: 12, skills: [{ name: '아이스 스피어', type: 'AP' }, { name: '썬더 스톰', type: 'AP' }, { name: '마법 증폭', type: 'PP' }, { name: '메테오 레인', type: 'AP' }] },
            { id: 'miel', name: 'Miel (미엘)', class: 'Cleric (성직자)', cost: 2, arcana: '긴급 치유', speed: 80, desc: '후열 힐러. 행동 속도가 빨라 아군에게 상태이상 해제와 회복 스킬을 신속하게 적용합니다.', imgSeed: 13, skills: [{ name: '힐', type: 'AP' }, { name: '리저렉션', type: 'PP' }, { name: '큐어', type: 'AP' }, { name: '세이프 가드', type: 'PP' }] },
            { id: 'kai', name: 'Kai (카이)', class: 'Shieldmaiden (방패병)', cost: 1, arcana: '경량 방어', speed: 55, desc: '저코스트 전열 방패병. 간단한 가드와 어그로 스킬을 가진 핵심 탱커입니다.', imgSeed: 16, skills: [{ name: '쉴드 배시', type: 'AP' }, { name: '풀 커버', type: 'PP' }, { name: '도발', type: 'AP' }, { name: 'HP 회복', type: 'PP' }] }
        ];

        // 2. 상태 관리
        let selectedCharacterId = null; // 현재 선택된 캐릭터 ID (풀 또는 슬롯)
        let unitSlots = Array(6).fill(null); // 부대 배치 상태 (null 또는 charId)
        // 작전 코딩 데이터 { charId: [{ skill: {name, type}, cond1: '조건', cond2: '조건' }, ...] }
        let codingData = {};

        // 모달 관련 상태
        let modalState = {
            targetCharId: null,
            targetRuleIndex: -1,
            targetConditionKey: null, // 'cond1' or 'cond2'
            selectedCategory: null
        };

        // 3. DOM 요소 참조
        const poolContainer = document.getElementById('character-pool-container');
        const slotElements = Array.from({ length: 6 }, (_, i) => document.getElementById(`slot-${i}`));
        const detailPanel = document.getElementById('detail-panel');
        const currentCostDisplay = document.getElementById('current-cost');
        const codingAreaContent = document.getElementById('coding-area-content');
        const codingPanelTitle = document.getElementById('coding-panel-title');
        const conditionModal = document.getElementById('condition-modal');
        const categoryList = document.getElementById('category-list');
        const conditionList = document.getElementById('condition-list');


        // 4. 유틸리티 함수
        const getCharacterById = (id) => characters.find(c => c.id === id);
        const getCostClass = (cost) => `cost-${cost}`;
        const calculateTotalCost = () => unitSlots.reduce((sum, charId) => sum + (charId ? getCharacterById(charId).cost : 0), 0);
        const getImageUrl = (char, size = '120x120') =>
            `https://image.pollinations.ai/prompt/${char.name.split(' ')[0]}%20${char.class.split(' ')[0]}%20fantasy%20profile%20bust?width=${size.split('x')[0]}&height=${size.split('x')[1]}&seed=${char.imgSeed}`;

        // 5. 렌더링 함수
        function createCharacterCardHTML(char, isDeployed = false) {
            const costClass = getCostClass(char.cost);
            // 이미 배치된 캐릭터는 opacity를 낮추고 선택 불가능하게 합니다.
            const deployedClass = isDeployed ? 'opacity-50 pointer-events-none border-teal-500' : 'border-gray-600 hover:border-teal-400';
            return `
            <div id="char-${char.id}" data-char-id="${char.id}" class="character-card ${deployedClass} border-2 transition" 
                 onclick="handleCharacterSelect('${char.id}')">
                <img src="${getImageUrl(char, '120x120')}" alt="${char.name}" class="w-full h-full object-cover">
                <div class="character-overlay rounded-b-xl">
                    ${char.name.split(' ')[0]} <span class="text-teal-300 font-normal">(${char.class.split(' ')[0]}, ${char.cost}C)</span>
                    <div class="absolute top-0 left-0 text-xs font-bold px-1 rounded-br-lg text-white ${costClass}">${char.cost}C</div>
                </div>
            </div>`;
        }

        function renderCharacterPool() {
            poolContainer.innerHTML = characters.map(char => createCharacterCardHTML(char, unitSlots.includes(char.id))).join('');
            // 이전에 선택된 풀 카드 하이라이트 제거 후 재적용
            document.querySelectorAll('.character-card').forEach(el => el.classList.remove('selected-pool-card'));
            if (selectedCharacterId && !unitSlots.includes(selectedCharacterId)) {
                document.getElementById(`char-${selectedCharacterId}`)?.classList.add('selected-pool-card');
            }
        }

        function renderUnitSlots() {
            const totalCost = calculateTotalCost();
            slotElements.forEach((slotEl, index) => {
                const charId = unitSlots[index];
                slotEl.innerHTML = '';
                slotEl.className = `slot-card ${charId ? 'deployed-card-slot p-0' : 'empty-slot cursor-pointer hover:bg-gray-700 transition'}`;
                slotEl.onclick = charId ? () => handleSlotSelect(index) : () => handleSlotClick(index);

                if (charId) {
                    const char = getCharacterById(charId);
                    slotEl.innerHTML = `
                    <div class="w-full h-full relative">
                        <img src="${getImageUrl(char, '120x120')}" alt="${char.name}" class="w-full h-full object-cover">
                        <div class="character-overlay rounded-b-xl">
                            ${char.name.split(' ')[0]} <span class="text-teal-300 font-normal">(${char.class.split(' ')[0]})</span>
                            <div class="absolute top-0 left-0 text-xs font-bold px-1 rounded-br-lg text-white ${getCostClass(char.cost)}">${char.cost}C</div>
                        </div>
                    </div>`;
                } else {
                    const position = index < 3 ? 'Front' : 'Back';
                    slotEl.innerHTML = `<span class="text-2xl mb-1">+</span> ${position} ${index % 3 + 1}`;
                }
            });

            currentCostDisplay.textContent = `${totalCost} / ${MAX_COST}`;
            currentCostDisplay.className = `font-extrabold text-lg ${totalCost > MAX_COST ? 'text-red-400 animate-pulse' : 'text-teal-400'}`;
        }

        function renderCharacterDetail(char, slotIndex) {
            if (!char) { detailPanel.classList.add('hidden'); return; }
            const positionText = slotIndex !== null ? `${slotIndex < 3 ? '전열' : '후열'} ${slotIndex % 3 + 1}` : '미배치';

            detailPanel.classList.remove('hidden');
            detailPanel.innerHTML = `
            <div class="w-40 h-40 relative rounded-xl overflow-hidden border-4 border-yellow-300 shadow-xl flex-shrink-0">
                <img src="${getImageUrl(char, '200x200')}" alt="${char.name}" class="w-full h-full object-cover">
                <div class="absolute top-0 right-0 text-white text-xs font-bold px-2 py-1 rounded-bl-lg ${getCostClass(char.cost)}">COST: ${char.cost}</div>
                <div class="absolute bottom-0 left-0 right-0 text-xs font-bold py-1 bg-black/70 text-white text-center">${positionText}</div>
            </div>
            <div class="flex-grow">
                <h2 class="text-2xl font-extrabold mb-2 text-teal-300">${char.name}</h2>
                <div class="grid grid-cols-2 gap-y-1 text-sm">
                    <div class="text-gray-400">클래스:</div> <div class="font-medium text-white">${char.class}</div>
                    <div class="text-gray-400">고유 아르카나:</div> <div class="font-medium text-yellow-400">${char.arcana}</div>
                    <div class="text-gray-400">행동 속도:</div> <div class="font-medium text-white">${char.speed}</div>
                </div>
                <div class="mt-4 pt-3 border-t border-gray-700">
                    <p class="text-sm text-gray-300">${char.desc}</p>
                    ${slotIndex !== null ? `<button class="mt-3 w-full text-xs py-1 bg-red-800/50 text-red-300 rounded-lg hover:bg-red-700/50 transition" onclick="handleRemoveFromUnit('${char.id}')">부대에서 제거</button>` : ''}
                </div>
            </div>`;
        }

        function renderCodingArea(char) {
            if (!char) {
                codingPanelTitle.textContent = "캐릭터 선택 대기";
                codingAreaContent.innerHTML = `<p class="text-gray-400 text-center py-12">캐릭터를 선택하세요.</p>`;
                return;
            }

            codingPanelTitle.textContent = `${char.name.split(' ')[0]} - 작전 코딩`;

            // 코딩 데이터 초기화 (배치 시에만)
            if (!codingData[char.id]) {
                codingData[char.id] = char.skills.map(skill => ({
                    skill: `${skill.name} (${skill.type})`,
                    cond1: DEFAULT_CONDITION,
                    cond2: DEFAULT_CONDITION
                }));
            }

            const currentCoding = codingData[char.id];

            const codingSlotsHtml = currentCoding.map((rule, i) => {
                const skillType = rule.skill.includes('(AP)') ? 'AP' : 'PP';
                const skillColor = skillType === 'AP' ? 'text-teal-300' : 'text-purple-300';

                // 데이터 속성을 사용하여 모달 호출 시 필요한 정보 전달
                const openModalAttr = (condKey) =>
                    `onclick="openModal('${char.id}', ${i}, '${condKey}')"`;

                return `
                <div class="coding-entry grid grid-cols-12 items-center bg-gray-700/50 p-2 rounded-lg border border-gray-700">
                    <div class="col-span-1 text-center font-bold text-yellow-300 text-base">${i + 1}</div>
                    <div class="col-span-3 text-sm ${skillColor} truncate pl-1 font-semibold">${rule.skill}</div>
                    
                    <!-- 조건 1 (Condition 1) -->
                    <div class="col-span-4 px-1">
                        <div class="condition-field" ${openModalAttr('cond1')}>
                            <span>${rule.cond1}</span>
                            <span class="text-gray-500 text-xs ml-2">...</span>
                        </div>
                    </div>
                    
                    <!-- 조건 2 (Condition 2) - AND 관계 명시 -->
                    <div class="col-span-4 px-1">
                        <div class="flex items-center">
                            <span class="text-[10px] text-yellow-500 font-bold mr-1 flex-shrink-0">AND</span>
                            <div class="condition-field flex-grow" ${openModalAttr('cond2')}>
                                <span>${rule.cond2}</span>
                                <span class="text-gray-500 text-xs ml-2">...</span>
                            </div>
                        </div>
                    </div>
                </div>`;
            }).join('');

            // 빈 슬롯 (스킬 슬롯이 6개 미만일 경우)
            const emptySlots = Array(Math.max(0, 6 - char.skills.length)).fill(0).map((_, i) => `
            <div class="grid grid-cols-12 items-center bg-gray-800/50 p-2 rounded-lg border border-dashed border-gray-600 opacity-50">
                <div class="col-span-1 text-center font-bold text-gray-600">${char.skills.length + 1 + i}</div>
                <div class="col-span-3 text-sm text-gray-500 italic">...</div>
                <div class="col-span-8 text-center text-xs text-gray-600">스킬 미보유</div>
            </div>`).join('');

            codingAreaContent.innerHTML = `
            <div class="grid grid-cols-12 text-xs font-bold text-gray-400 py-2 border-b border-gray-700 sticky top-0 bg-gray-800 z-10">
                <div class="col-span-1 text-center">No.</div>
                <div class="col-span-3 pl-1">사용 스킬</div>
                <div class="col-span-4 pl-1">조건 1</div>
                <div class="col-span-4 pl-1">조건 2 (<span class="text-yellow-400 font-bold">AND</span>)</div>
            </div>
            <div class="space-y-2 mt-2 pb-4">${codingSlotsHtml}${emptySlots}</div>`;
        }

        // 6. 모달 제어 함수

        function openModal(charId, ruleIndex, conditionKey) {
            modalState.targetCharId = charId;
            modalState.targetRuleIndex = ruleIndex;
            modalState.targetConditionKey = conditionKey;
            modalState.selectedCategory = null; // 카테고리 초기화

            conditionModal.classList.remove('hidden');
            renderCategories();
            renderDetails(); // 상세 조건 초기 화면 출력
        }

        function closeModal() {
            conditionModal.classList.add('hidden');
            // 상태 초기화
            modalState.targetCharId = null;
            modalState.targetRuleIndex = -1;
            modalState.targetConditionKey = null;
            modalState.selectedCategory = null;
        }

        function renderCategories() {
            categoryList.innerHTML = '';
            const categories = Object.keys(TACTICS_DB);

            // '조건 없음' 카테고리를 맨 위에 추가합니다.
            const noConditionEl = document.createElement('div');
            noConditionEl.className = 'modal-list-item modal-list-item-category bg-red-700 hover:bg-red-600';
            noConditionEl.textContent = '조건 없음 (초기화)';
            noConditionEl.onclick = () => selectCondition(DEFAULT_CONDITION);
            categoryList.appendChild(noConditionEl);

            categories.forEach(category => {
                const el = document.createElement('div');
                el.className = 'modal-list-item modal-list-item-category';
                if (modalState.selectedCategory === category) {
                    el.classList.add('selected');
                }
                el.textContent = category.replace(/_/g, ' ');
                el.onclick = () => {
                    modalState.selectedCategory = category;
                    renderCategories(); // 선택된 카테고리 하이라이트
                    renderDetails();
                };
                categoryList.appendChild(el);
            });
        }

        function renderDetails() {
            conditionList.innerHTML = '';
            const category = modalState.selectedCategory;

            if (!category) {
                conditionList.innerHTML = `<p class="text-center text-gray-400 mt-12">좌측에서 카테고리를 선택해 주세요.</p>`;
                return;
            }

            const conditions = TACTICS_DB[category] || [];

            conditions.forEach(condition => {
                const el = document.createElement('div');
                el.className = 'modal-list-item modal-list-item-detail';
                el.textContent = condition;
                el.onclick = () => selectCondition(condition);
                conditionList.appendChild(el);
            });
        }

        function selectCondition(conditionValue) {
            const { targetCharId, targetRuleIndex, targetConditionKey } = modalState;

            if (targetCharId && targetRuleIndex !== -1 && targetConditionKey) {
                // 코딩 데이터 업데이트
                codingData[targetCharId][targetRuleIndex][targetConditionKey] = conditionValue;
                updateUI();
            }
            closeModal();
        }


        // 7. 이벤트 핸들러
        function handleCharacterSelect(charId) {
            selectedCharacterId = charId;
            updateUI();
        }

        function handleSlotClick(index) {
            if (selectedCharacterId) {
                const char = getCharacterById(selectedCharacterId);
                const totalCost = calculateTotalCost();

                if (totalCost + char.cost > MAX_COST) {
                    const messageBox = document.createElement('div');
                    messageBox.className = "fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50";
                    messageBox.innerHTML = `
                    <div class="bg-gray-700 p-6 rounded-lg shadow-xl border-t-4 border-red-500">
                        <h3 class="text-xl font-bold text-red-400 mb-3">코스트 초과 경고</h3>
                        <p class="text-gray-200">해당 캐릭터를 배치하면 부대 총 코스트(${totalCost + char.cost})가 최대 허용치(${MAX_COST})를 초과합니다.</p>
                        <button onclick="this.parentNode.parentNode.remove()" class="mt-4 w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-2 rounded-lg transition">확인</button>
                    </div>`;
                    document.body.appendChild(messageBox);
                    return;
                }

                // 배치 및 코딩 데이터 초기화
                unitSlots[index] = selectedCharacterId;
                // 코딩 데이터 초기화는 renderCodingArea에서 처리되도록 유도

                updateUI();
            }
        }

        function handleSlotSelect(index) {
            handleCharacterSelect(unitSlots[index]);
        }

        function handleRemoveFromUnit(charId) {
            const idx = unitSlots.indexOf(charId);
            if (idx !== -1) unitSlots[idx] = null;

            // 코딩 데이터 삭제
            delete codingData[charId];

            selectedCharacterId = null;
            updateUI();
        }

        document.getElementById('clear-unit-btn').onclick = () => {
            unitSlots.fill(null);
            codingData = {}; // 코딩 데이터도 모두 초기화
            selectedCharacterId = null;
            updateUI();
        };

        function updateUI() {
            renderCharacterPool();
            renderUnitSlots();
            const char = selectedCharacterId ? getCharacterById(selectedCharacterId) : null;
            const slotIndex = unitSlots.indexOf(selectedCharacterId);

            renderCharacterDetail(char, slotIndex !== -1 ? slotIndex : null);
            renderCodingArea(char);

            // 슬롯 하이라이트 처리
            slotElements.forEach((el, i) => el.classList.remove('active-slot'));
            if (char) {
                // 선택된 캐릭터가 배치되어 있으면 해당 슬롯 하이라이트
                if (slotIndex !== -1) {
                    slotElements[slotIndex].classList.add('active-slot');
                    // 배치되지 않은 캐릭터가 선택되었으면, 빈 슬롯 하이라이트 (배치 유도)
                } else {
                    slotElements.forEach((el, i) => !unitSlots[i] && el.classList.add('active-slot'));
                }
            }
        }

        window.onload = updateUI;
    </script>

</body>

</html>